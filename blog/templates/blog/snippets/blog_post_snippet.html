{% load tz %}
<style type="text/css">
    .card{
        max-width: 700px;
        width: 100%;
    }
    .card-body{
        padding: 20px;
        width: 100%;
    }

    /* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content/Box */
.modal-content {
  background-color: #fefefe;
  margin: 15% auto; /* 15% from the top and centered */
  padding: 20px;
  border: 1px solid #888;
  width: 80%; /* Could be more or less, depending on screen size */
}

/* The Close Button */
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}



.fa-thumbs-up{
    color:blue;
    text-shadow: 1px 1px 1px #ccc;
    font-size: 1.5em;
}

.fa-thumbs-down{
    color:red;
    text-shadow: 1px 1px 1px #ccc;
    font-size: 1.5em;
}

.like-count{
    color: blue;
    font-size: 1.5em
}

</style>

{%if blog_post%}
<div class="container">
    <div class="row">

        <!-- Blog Post -->
        <div class="card m-auto">
            <img class="card-img-top" src="{{blog_post.image.url}}" alt="Image is not available at this moment">
            <div class="card-body mt-2 mb-2">
                <h2 class="card-title">{{blog_post.title}}</h2>
                <div class="card-footer text-muted text-right">
                  -By {{blog_post.author}} on{%timezone "Asia/Calcutta"%} {{blog_post.datetime_published}}{% endtimezone %}
                </div>
                <p class="card-text">{{blog_post.body|truncatechars:15|linebreaksbr}}
                    <a href="{% url 'blog:detail' post.slug%}">(Read more)</a>
                </p>
            <hr>

            <div id="{{ blog_post.id }}">
                {% if not request.user in blog_post.liked_by.all %}
                    <i onclick="handleAction({{ blog_post.id }},{{ request.user.id }},1)" class="fa fa-thumbs-up">Like</i>
                {% else %}
                    <i onclick="handleAction({{ blog_post.id }},{{ request.user.id }},0)" class="fa fa-thumbs-down">Unlike</i>
                {% endif %}
            </div>

            <div id="count-{{ blog_post.id }}" class="like-count" >
               {{ blog_post.liked_by.all.count }} Likes
            </div>


            </div>
        </div>
    </div>
</div>

{%else%}
<div class="container">
    <div class="row">
        <div class="card m-auto">
            <div class="card-body mt-2 mb-2">
                <h2 class="card-title">
                    Such emptiness.....
                </h2>
            </div>
        </div>
    </div>
</div>
{%endif%}


<script type="text/javascript">


    function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}



    function handleAction(postId,userId,action){
        const csrftoken = getCookie('csrftoken');
        let url='{%url "blog:react"%}'
        const method='POST'
        const data=JSON.stringify({
            postId:postId,
            userId:userId,
            action:action
        })

        const xhr=new XMLHttpRequest()
        xhr.open(method,url)
        xhr.setRequestHeader("Content-Type","application/json")
        xhr.setRequestHeader("HTTP_X_REQUESTED_WITH","XMLHttpRequest")
        xhr.setRequestHeader("X-Requested-With","XMLHttpRequest")
        xhr.setRequestHeader("X-CSRFToken",csrftoken)
        xhr.send(data)


        let likeElement=document.getElementById(postId)
        let likeCountElement=document.getElementById(`count-${postId}`)
        let count=parseInt(likeCountElement.innerText.trim().split(" ")[0]);
        if(action===1){
            likeElement.innerHTML=`<i onclick="handleAction(${postId},${ userId },0)" class="fa fa-thumbs-down">Unlike</i>`
            likeCountElement.innerText=`${count+1} Likes`;
        }
        else{
            likeElement.innerHTML=`<i onclick="handleAction(${postId},${userId},1)" class="fa fa-thumbs-up">Like</i>`
            likeCountElement.innerText=`${Math.max(0,count-1)} Likes`;
        }

    }


</script>